# 3D 뷰어 구현 사양서

> 이 문서는 Bridge BIM Platform의 3D 뷰어에서 렌더링되는 교량 구조와 구현 방식을 설명합니다.

## 📋 목차

- [빠른 시작](#빠른-시작)
- [교량 구조 개요](#교량-구조-개요)
- [컴포넌트 상세 정보](#컴포넌트-상세-정보)
- [3D 렌더링 구현](#3d-렌더링-구현)
- [사용 방법](#사용-방법)
- [문제 해결](#문제-해결)

---

## 🚀 빠른 시작

### 3D 뷰어가 렌더링하는 것

현재 구현된 3D 뷰어는 **해상 사장교 (Cable-Stayed Bridge)** 구조를 렌더링합니다.

**주요 특징:**
- ✅ 총 **18개 부재**로 구성
- ✅ 주탑 1개, 상판 1개, 교각 6개, 케이블 10개
- ✅ Three.js 기반 실시간 3D 렌더링
- ✅ 부재 선택 및 하이라이트 기능
- ✅ 카메라 자동 포커스

### 화면에서 확인하기

1. 교량 상세 페이지(`/bridges/:id`)로 이동
2. 3D 뷰어 영역에서 교량 모델 확인
3. 마우스로 회전, 줌, 팬 조작 가능
4. 부재 목록에서 부재 클릭 시 해당 부재 하이라이트

---

## 🏗️ 교량 구조 개요

### 교량 타입

| 항목 | 값 |
|------|-----|
| **교량 종류** | 해상 사장교 (Cable-Stayed Bridge) |
| **구조 형식** | 단일 주탑 사장교 (Single Pylon Cable-Stayed Bridge) |
| **총 부재 수** | 18개 |
| **전체 길이** | 180m |
| **전체 높이** | 45m |
| **전체 폭** | 14m |

### 좌표계 이해하기

3D 뷰어에서 사용하는 좌표계:

```
      Y (높이)
      ↑
      |
      |
      +----→ X (교량 길이 방향)
     /
    /
   Z (교량 폭 방향)
```

**좌표계 설명:**
- **X축**: 교량 길이 방향 (좌측: 음수, 우측: 양수)
- **Y축**: 높이 (지면: 0, 위로 양수)
- **Z축**: 교량 폭 방향 (전방: 양수, 후방: 음수)
- **단위**: 미터 (1 unit = 1m)

**실제 사용 예시:**
- 주탑 위치: `[0, 0, 0]` (교량 중앙, 지면)
- 상판 중앙: `[0, 19, 0]` (교량 중앙, 높이 19m)

---

## 📦 컴포넌트 상세 정보

### 부재 목록

| 부재 | 개수 | 타입 | 상태 |
|------|------|------|------|
| 주탑 | 1 | Pylon | SAFE |
| 상판 | 1 | Deck | SAFE |
| 교각 | 6 | Column | SAFE |
| 케이블 | 10 | Cable | 9개 SAFE, 1개 WARNING |

### 1. 주탑 (Pylon)

**기본 정보:**
- **ID**: `pylon-main`
- **이름**: 주탑
- **타입**: Pylon
- **재료**: 콘크리트 (Concrete)
- **상태**: SAFE (초록색)

**위치 및 크기:**
- **위치**: 상판 중앙 (X=0 기준)
- **높이**: 45m
- **폭**: 4m (X 방향)
- **두께**: 4m (Z 방향)
- **바운딩 박스**: `[-2, 0, -2]` ~ `[2, 45, 2]`

**3D 형상:**
- 원기둥 (CylinderGeometry)
- 반지름: 2m
- 높이: 45m
- 세그먼트: 32

### 2. 상판 (Deck)

**기본 정보:**
- **ID**: `deck-main`
- **이름**: 상판
- **타입**: Deck
- **재료**: 콘크리트 (Concrete)
- **상태**: SAFE (초록색)

**위치 및 크기:**
- **길이**: 180m (X 방향, -90m ~ +90m)
- **폭**: 14m (Z 방향, -7m ~ +7m)
- **두께**: 1.2m (Y 방향, 18m ~ 19.2m)
- **바운딩 박스**: `[-90, 18, -7]` ~ `[90, 19.2, 7]`

**3D 형상:**
- 박스 (BoxGeometry)
- 크기: 180m × 1.2m × 14m

### 3. 해상 교각 (Piers) - 6개

**공통 사양:**
- **재료**: 콘크리트 (Concrete)
- **높이**: 18m
- **폭**: 3m (X 방향)
- **두께**: 3m (Z 방향)
- **상태**: 모두 SAFE (초록색)
- **3D 형상**: 원기둥 (반지름 1.5m, 높이 18m)

**교각 배치 (주탑 기준 좌우 대칭, 30m 간격):**

| 교각 ID | 위치 (X) | 바운딩 박스 |
|---------|---------|-------------|
| `pier-1` | -74m | `[-75.5, 0, -1.5]` ~ `[-72.5, 18, 1.5]` |
| `pier-2` | -44m | `[-45.5, 0, -1.5]` ~ `[-42.5, 18, 1.5]` |
| `pier-3` | -14m | `[-15.5, 0, -1.5]` ~ `[-12.5, 18, 1.5]` |
| `pier-4` | +14m | `[12.5, 0, -1.5]` ~ `[15.5, 18, 1.5]` |
| `pier-5` | +44m | `[42.5, 0, -1.5]` ~ `[45.5, 18, 1.5]` |
| `pier-6` | +74m | `[72.5, 0, -1.5]` ~ `[75.5, 18, 1.5]` |

### 4. 사장 케이블 (Cables) - 10개

**공통 사양:**
- **재료**: 강재 (Steel)
- **직경**: 0.12m
- **시작점**: 주탑 상단 중앙 `[0, 45, 0]`
- **연결점**: 상판 상부 (Y=19m)
- **3D 형상**: 원기둥 (반지름 0.1m, 세그먼트 16)

**케이블 배치 (주탑 기준 좌우 대칭, 15m 간격):**

#### 좌측 케이블 (5개)

| 케이블 ID | 끝점 (X) | 장력 | 상태 |
|-----------|---------|------|------|
| `cable-1` | -75m | 4200 kN | ⚠️ WARNING |
| `cable-2` | -60m | 4100 kN | ✅ SAFE |
| `cable-3` | -45m | 4000 kN | ✅ SAFE |
| `cable-4` | -30m | 3900 kN | ✅ SAFE |
| `cable-5` | -15m | 3800 kN | ✅ SAFE |

#### 우측 케이블 (5개)

| 케이블 ID | 끝점 (X) | 장력 | 상태 |
|-----------|---------|------|------|
| `cable-6` | +15m | 3800 kN | ✅ SAFE |
| `cable-7` | +30m | 3900 kN | ✅ SAFE |
| `cable-8` | +45m | 4000 kN | ✅ SAFE |
| `cable-9` | +60m | 4100 kN | ✅ SAFE |
| `cable-10` | +75m | 4200 kN | ✅ SAFE |

**케이블 회전 계산:**
케이블은 대각선으로 배치되며, 자동으로 회전 각도가 계산됩니다:
- **Y축 회전 (수평)**: `atan2(dx, dz)` - XZ 평면에서의 각도
- **X축 회전 (수직)**: `-atan2(dy, horizontalDist)` - 수직 대각선 각도
- `dx = endX - startX`, `dy = endY - startY`, `dz = endZ - startZ`
- `horizontalDist = sqrt(dx² + dz²)`

---

## 🔗 구조 관계 (Relationships)

### 관계 유형

부재 간의 관계는 다음과 같이 정의됩니다:

| 관계 타입 | 설명 | 예시 |
|---------|------|------|
| `SUPPORTS` | 지지 관계 | 주탑 → 케이블, 케이블 → 상판 |

### 관계 목록

**주탑 → 케이블 연결 (10개)**
- `pylon-main` → `cable-1` ~ `cable-10` (모두 SUPPORTS)

**케이블 → 상판 연결 (10개)**
- `cable-1` ~ `cable-10` → `deck-main` (모두 SUPPORTS)

**교각 → 상판 연결 (6개)**
- `pier-1` ~ `pier-6` → `deck-main` (모두 SUPPORTS)

**총 관계 수**: 26개

---

## 🎨 3D 렌더링 구현

### Three.js 설정

**렌더러:**
- WebGLRenderer
- Antialiasing 활성화

**카메라:**
- PerspectiveCamera
- FOV: 75도
- Near: 0.1m
- Far: 10000m

**조명:**
- AmbientLight (전체 조명, 강도 0.6)
- DirectionalLight 1 (위치 `[10, 10, 10]`, 강도 0.8)
- DirectionalLight 2 (위치 `[-10, 5, -10]`, 강도 0.4)

**컨트롤:**
- OrbitControls
- Damping: 0.05
- Zoom/Pan 활성화

**배경색:** 어두운 회색 (`0x222222`)

### 컴포넌트별 3D 형상 생성 규칙

#### 원기둥 형상 (주탑, 교각)
- **형상**: CylinderGeometry
- **반지름**: 바운딩 박스의 X/Z 중 최대값의 절반
- **높이**: 바운딩 박스의 Y 차이
- **세그먼트**: 32

#### 케이블 형상
- **형상**: CylinderGeometry
- **반지름**: 0.1m (고정)
- **높이**: 시작점과 끝점 사이의 대각선 거리
- **세그먼트**: 16
- **회전**: 시작점과 끝점을 연결하는 대각선 방향으로 자동 회전

#### 박스 형상 (상판)
- **형상**: BoxGeometry
- **크기**: 바운딩 박스의 X, Y, Z 차이

### 상태별 색상

| 상태 | 색상 코드 | 설명 |
|------|----------|------|
| **SAFE** | `0x16a34a` | 초록색 (안전) |
| **WARNING** | `0xca8a04` | 노란색 (주의) |
| **DANGER** | `0xdc2626` | 빨간색 (위험) |
| **기본** | `0x4a90e2` | 파란색 (기본) |

### 재질 속성

- **타입**: MeshStandardMaterial
- **Metalness**: 0.3
- **Roughness**: 0.7

### 카메라 자동 포커스

모든 컴포넌트 로드 후, 전체 바운딩 박스를 계산하여 카메라를 자동으로 조정합니다:

1. **중심점 계산**: 모든 바운딩 박스의 중심
2. **거리 계산**: 최대 크기의 2배
3. **카메라 위치**: 중심점에서 `(0.7, 0.5, 0.7)` 방향으로 거리만큼 이동

### 선택 하이라이트

부재를 선택하면 다음과 같이 하이라이트됩니다:

- **Emissive 색상**: `0x444444`
- **Emissive 강도**: 0.5
- 선택된 부재가 발광 효과로 강조됨

---

## 💻 사용 방법

### 개발자용: 컴포넌트 사용

```tsx
import { ThreeViewer } from '@/features/bim-viewer/components'

function BridgeDetailPage() {
  return (
    <div>
      <ThreeViewer 
        modelId="bim-model-1"
        selectedComponentId={selectedId}
        onComponentSelect={handleSelect}
      />
    </div>
  )
}
```

### 사용자용: 화면 조작

**마우스 조작:**
- **좌클릭 + 드래그**: 회전
- **우클릭 + 드래그**: 팬 (이동)
- **휠 스크롤**: 줌 인/아웃

**부재 선택:**
1. 부재 목록에서 부재 클릭
2. 해당 부재가 3D 뷰어에서 하이라이트됨
3. 속성 패널에 부재 정보 표시

---

## 🔍 문제 해결

### Q: 3D 모델이 보이지 않아요

**해결 방법:**
1. 브라우저 콘솔에서 에러 확인
2. WebGL 지원 여부 확인 (`chrome://gpu` 또는 `about:support`)
3. 네트워크 탭에서 BIM 모델 데이터 로딩 확인

### Q: 부재 선택이 안 돼요

**해결 방법:**
1. 부재 목록이 로드되었는지 확인
2. 브라우저 콘솔에서 클릭 이벤트 로그 확인
3. `selectedComponentId` prop이 올바르게 전달되는지 확인

### Q: 카메라가 이상한 위치에 있어요

**해결 방법:**
1. "전체 보기" 버튼 클릭 (구현 예정)
2. 브라우저 새로고침
3. 카메라 자동 포커스가 완료될 때까지 대기

### Q: 성능이 느려요

**해결 방법:**
1. 브라우저 하드웨어 가속 확인
2. 다른 탭에서 GPU 사용량이 높은지 확인
3. 부재 수가 많은 경우 필터 사용 (구현 예정)

---

## 📊 구조적 특징

### 대칭성
- 주탑(X=0)을 기준으로 좌우 완전 대칭
- 케이블과 교각이 대칭적으로 배치

### 간격
- **케이블 간격**: 15m 일정 간격으로 하중 분산
- **교각 간격**: 30m 일정 간격으로 상판 지지

### 배치
- **부채꼴 배치**: 케이블이 주탑 상단에서 방사형으로 퍼짐
- **균등 하중 분산**: 구조 안정성 확보

---

## 📝 디버깅 정보

3D 뷰어는 다음 정보를 콘솔에 출력합니다:

- ✅ 렌더링 시작 시 총 부재 수
- ✅ 각 부재 추가 시 이름, 타입, 위치
- ✅ 케이블 회전 각도 (Y축, X축)
- ✅ 모든 부재 렌더링 완료 시 총 메시 수
- ✅ 카메라 포커스 완료 시 중심점과 크기

**콘솔 로그 예시:**
```
[ThreeViewer] 렌더링 시작: 총 18개 부재
[ThreeViewer] 부재 추가: 주탑 (Pylon) 위치: [0, 0, 0]
[ThreeViewer] 케이블 회전: Y축 90도, X축 -45도
[ThreeViewer] 렌더링 완료: 총 18개 메시
[ThreeViewer] 카메라 포커스: 중심 [0, 22.5, 0], 크기 [180, 45, 14]
```

---

## 🔄 향후 개선 사항

- [ ] glTF 파일 로딩 지원
- [ ] 부재 필터링 기능
- [ ] 측정 도구 추가
- [ ] 섹션 커팅 기능
- [ ] 애니메이션 (시공 시뮬레이션)

---

**마지막 업데이트**: 2024년
